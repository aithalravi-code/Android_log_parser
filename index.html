<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android Log Viewer</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Log level color coding */
        .log-line.log-line-meta { color: #FF9800; font-style: italic; } /* Orange for file headers */

        .reset-section {
            margin-top: 15px;
            padding: 5px;
        }
        /* Style for the user-selected anchor line */
        .log-line.selected-anchor {
            background-color: #2c3e50; /* A dark slate blue for contrast */
            border-left: 3px solid #3498db; /* A bright blue left border */
        }
        #clearStateBtn {
            width: 100%;
            padding: 8px;
            background-color: #c62828; /* A reddish color to indicate a destructive action */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        /* Indicator for available special logs like BTSnoop */
        .tab-btn .indicator {
            color: #34a853; /* Google Green */
            font-size: 1.2em;
            line-height: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Android Log Viewer</h1>
            <div id="current-file-display" class="current-file-display"></div>
        </header>
        <main>
            <div class="left-panel">
                <button id="panel-toggle-btn" class="panel-toggle-btn" title="Toggle Filters Panel">&laquo;</button>
                <details id="file-selection-details" open>
                    <summary>File Selection</summary>
                    <div class="upload-column" id="upload-column">
                        <div class="upload-choice">
                            <input type="radio" id="fileChoice" name="uploadType" value="files" checked>
                            <label for="fileChoice">ZIP or Log Files</label>
                            <input type="radio" id="folderChoice" name="uploadType" value="folder">
                            <label for="folderChoice">Folder</label>
                        </div>
                        <div id="folderInputContainer" class="upload-section" style="display: none;">
                            <label for="zipInput" class="upload-label">Choose a folder containing logs:</label>
                            <input type="file" id="zipInput" webkitdirectory directory />
                        </div>
                        <div id="fileInputContainer" class="upload-section">
                            <label for="logFilesInput" class="upload-label">Choose ZIP or individual log files:</label>
                            <input type="file" id="logFilesInput" accept=".zip,.txt,.log" multiple />
                        </div>
                    </div>
                    <div class="reset-section">
                        <button id="clearStateBtn" title="Clear all loaded data and reset filters">Clear & Reset</button>
                    </div>
                </details>
                <div class="filter-column">
                    <section class="filter-section" id="filterSection">
                        <div class="log-level-filters">
                            <span>Filter by Level:</span>
                            <button class="filter-icon active" data-level="V">Verbose</button>
                            <button class="filter-icon active" data-level="D">Debug</button>
                            <button class="filter-icon active" data-level="I">Info</button>
                            <button class="filter-icon active" data-level="W">Warn</button>
                            <button class="filter-icon active" data-level="E">Error</button>
                            <button id="logLevelToggleBtn" class="filter-action-btn">None</button>
                        </div>
                    </section>
                    <section class="search-section">
                        <label for="searchInput">Keyword Search:</label>
                        <div class="logic-toggle">
                            <button id="logicOrBtn" class="logic-btn active" title="Show lines that match ANY active keyword">OR</button>
                            <button id="logicAndBtn" class="logic-btn" title="Show lines that match ALL active keywords">AND</button>
                        </div>
                        <input type="text" id="searchInput" class="search-input" placeholder="Live search or type & Enter..." autocomplete="off" />
                        <div id="keywordChips" class="keyword-chips"></div>
                        <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
                    </section>
                    <section class="time-range-section">
                        <label for="startTime">Time Range:</label>
                        <div class="time-filter-controls">
                            <input type="datetime-local" id="startTime" />
                            <input type="datetime-local" id="endTime" />
                        </div>
                        <!-- Slider container, now outside the controls flexbox -->
                        <div id="timeRangeSliderContainer" style="width: 100%; padding: 20px 5px 10px 5px; box-sizing: border-box; display: none;">
                           <div id="timeRangeSlider"></div>
                        </div>
                    </section>
                </div>
                <div id="resize-handle" class="resize-handle"></div>
            </div>
            <div class="main-content">
                <nav class="tab-nav">
                    <button class="tab-btn active" data-tab="logs">Logs</button>
                    <button class="tab-btn" data-tab="ble">Bluetooth</button>
                    <button class="tab-btn" data-tab="nfc">NFC</button>
                    <button class="tab-btn" data-tab="dck">DCK</button>
                    <button class="tab-btn" data-tab="btsnoop">BTSnoop <span id="btsnoopIndicator" class="indicator" style="display: none;">‚óè</span></button>
                    <button class="tab-btn" data-tab="kernel">Kernel</button>
                    <button class="tab-btn" data-tab="stats">Stats</button>
                </nav>
                <section id="logsTab" class="tab-content active">
                    <div id="logContainer" class="log-container">
                        <div id="logSizer" class="log-sizer"></div>
                        <div id="logViewport" class="log-viewport"></div>
                    </div>
                    <button id="exportLogsBtn" class="export-btn">Export Filtered Logs</button>
                </section>
                <section id="bleTab" class="tab-content">
                    <div class="log-level-filters ble-filters">
                        <span>Filter by Layer:</span>
                        <button class="filter-icon active" data-ble-filter="manager">Manager</button>
                        <button class="filter-icon active" data-ble-filter="gatt">GATT</button>
                        <button class="filter-icon active" data-ble-filter="smp">SMP</button>
                        <button class="filter-icon active" data-ble-filter="hci">HCI</button>
                    </div>
                    <div id="bleLogContainer" class="log-container">
                        <div id="bleLogSizer" class="log-sizer"></div>
                        <div id="bleLogViewport" class="log-viewport"></div>
                    </div>
                    <button id="exportBleBtn" class="export-btn">Export Filtered Logs</button>
                </section>
                <section id="statsTab" class="tab-content" style="overflow-y: auto; padding: 1rem;">
                    <div class="dashboard-grid">
                        <div class="dashboard-card" id="logSummaryCard">
                            <h3>Log Summary</h3>
                            <div id="logCounts"></div>
                            <div id="errorDistribution"></div>
                        </div>
                        <div class="dashboard-card" id="cpuLoadCard">
                            <h3>CPU Load</h3>
                            <div id="cpuLoadPlotContainer" class="plot-container"></div>
                            <div id="cpuLoadStats"></div>
                        </div>
                        <div class="dashboard-card" id="temperatureCard">
                            <h3>Device Temperature</h3>
                            <div id="temperaturePlotContainer" class="plot-container"></div>
                            <div id="temperatureStats"></div>
                        </div>
                        <div class="dashboard-card large-card" id="highlightsCard">
                            <h3>Highlights</h3>
                            <div class="highlight-section">
                                <h4>Accounts Found</h4>
                                <ul id="accountsList" class="highlight-list"></ul>
                            </div>
                            <div class="highlight-section">
                                <h4>Device & Setting Events</h4>
                                <table id="deviceEventsTable" class="highlight-table">
                                    <thead><tr><th>Date</th><th>Timestamp</th><th>Event</th><th>New Value</th><th>Previous Value</th><th>Log Line</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="highlight-section">
                                <h4>BLE Security Keys</h4>
                                <table id="bleKeysTable" class="highlight-table">
                                    <thead><tr><th>Peer Address</th><th>Key Type</th><th>Key Value</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="highlight-section">
                                <h4>BLE Security Keys</h4>
                                <table id="bleKeysTable" class="highlight-table">
                                    <thead><tr><th>Peer Address</th><th>Key Type</th><th>Key Value</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="dashboard-card" id="appVersionsCard">
                            <h3>Application Versions</h3>
                            <div class="search-section" style="padding: 0 5px 10px 5px;">
                                <label for="appSearchInput" style="display: none;">Search Apps:</label>
                                <input type="text" id="appSearchInput" class="search-input" placeholder="Search packages..." autocomplete="off">
                            </div>
                            <div class="scrollable-table-container">
                                <table id="appVersionsTable" class="highlight-table">
                                    <thead>
                                        <tr>
                                            <th>Package</th>
                                            <th>Version</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="nfcTab" class="tab-content">
                    <div class="log-level-filters nfc-filters">
                        <span>Filter by Layer:</span>
                        <button class="filter-icon active" data-nfc-filter="framework">Framework</button>
                        <button class="filter-icon active" data-nfc-filter="hce">Card Emulation</button>
                        <button class="filter-icon active" data-nfc-filter="p2p">P2P</button>
                        <button class="filter-icon active" data-nfc-filter="hal">HAL/Native</button>
                    </div>
                    <div id="nfcLogContainer" class="log-container">
                        <div id="nfcLogSizer" class="log-sizer"></div>
                        <div id="nfcLogViewport" class="log-viewport"></div>
                    </div>
                    <button id="exportNfcBtn" class="export-btn">Export Filtered Logs</button>
                </section>
                <section id="dckTab" class="tab-content">
                    <div class="log-level-filters dck-filters">
                        <span>Filter by Layer:</span>
                        <button class="filter-icon active" data-dck-filter="manager">Manager</button>
                        <button class="filter-icon active" data-dck-filter="hal">HAL</button>
                        <button class="filter-icon active" data-dck-filter="oem">OEM</button>
                    </div>
                    <div id="dckLogContainer" class="log-container">
                        <div id="dckLogSizer" class="log-sizer"></div>
                        <div id="dckLogViewport" class="log-viewport"></div>
                    </div>
                    <button id="exportDckBtn" class="export-btn">Export Filtered Logs</button>
                </section>
                <section id="kernelTab" class="tab-content">
                    <!-- Kernel logs are shown without sub-filters for now -->
                    <div id="kernelLogContainer" class="log-container">
                        <div id="kernelLogSizer" class="log-sizer"></div>
                        <div id="kernelLogViewport" class="log-viewport"></div>
                    </div>
                    <button id="exportKernelBtn" class="export-btn">Export Filtered Logs</button>
                </section>
                <section id="btsnoopTab" class="tab-content">
                    <div id="btsnoopFilterContainer" style="display: none;">
                        <div class="log-level-filters btsnoop-filters">
                            <span>Filter by Type:</span>
                            <button class="filter-icon active" data-btsnoop-filter="cmd">HCI Cmd</button>
                            <button class="filter-icon active" data-btsnoop-filter="evt">HCI Evt</button>
                            <button class="filter-icon active" data-btsnoop-filter="acl">ACL Data</button>
                            <button class="filter-icon active" data-btsnoop-filter="l2cap">L2CAP</button>
                            <button class="filter-icon active" data-btsnoop-filter="smp">SMP</button>
                            <button class="filter-icon active" data-btsnoop-filter="att">ATT</button>
                        </div>
                    </div>
                    <div id="btsnoopInitialView" style="text-align: center; padding: 4rem 0;">
                        <!-- This content will be managed by JS -->
                    </div>
                    <div id="btsnoopContentView" class="log-container" style="display: none;">
                        <table class="highlight-table btsnoop-table">
                            <thead>
                                <tr><th>No.</th><th>Timestamp</th><th>Source</th><th>Destination</th><th>Type</th><th>Summary</th><th>Data</th></tr>
                                <tr class="btsnoop-column-filters">
                                    <th><input type="text" data-column="0" placeholder="Filter No."></th>
                                    <th><input type="text" data-column="1" placeholder="Filter Time"></th>
                                    <th><input type="text" data-column="2" placeholder="Filter Source"></th>
                                    <th><input type="text" data-column="3" placeholder="Filter Dest."></th>
                                    <th><input type="text" data-column="4" placeholder="Filter Type"></th>
                                    <th><input type="text" data-column="5" placeholder="Filter Summary"></th>
                                    <th><input type="text" data-column="6" placeholder="Filter Data"></th>
                                </tr>
                            </thead>
                            <tbody id="btsnoopLogViewport"></tbody>
                        </table>
                    </div>
                    <button id="exportBtsnoopXlsxBtn" class="export-btn" style="display: none;">Export to Excel</button>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal for selecting files from a ZIP -->
    <div id="zipModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Files Found in ZIP</h2>
            <p>Please select the log files you want to load.</p>
            <div class="toggle-all-container">
                <input type="checkbox" id="toggleAllFiles" checked />
                <label for="toggleAllFiles">Select / Deselect All</label>
            </div>
            <div id="zipFileSelection" class="file-selection-list">
                <!-- Checkboxes will be dynamically inserted here -->
            </div>
            <div class="modal-actions">
                <button id="loadSelectedBtn" class="modal-btn">Load Selected Files</button>
                <button id="cancelZipSelectionBtn" class="modal-btn cancel">Cancel</button>
            </div>
        </div>
    </div>

    <div class="progress-bar-container fixed-bottom-right">
        <div id="progressBar" class="progress-bar"></div>
        <span id="progressText" class="progress-text"></span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <!-- noUiSlider for the time range slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" integrity="sha512-qveKnGrvOChbSzAdtSs8p69eoLegyh+1hwOMbmpCViIwj7rn4oJjdmMvWOuyQlTOZgTlZA0N2PXA7iA8/2TUYA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js" integrity="sha512-UOJe4paV6hYWBnS0c9GnIRH8PLm2nFK22uhfAvsTIqd3uwnWsVri1OPn5fJYdLtGY3wB11LGHJ4yPU1WFJeBYQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="main.js"></script>
</body>
</html>
