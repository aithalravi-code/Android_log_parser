<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android Log Viewer</title>
    <style>
        /* Log level color coding */
        .log-line.log-line-meta {
            color: #FF9800;
            font-style: italic;
        }

        /* Orange for file headers */

        .reset-section {
            margin-top: 15px;
            padding: 5px;
        }

        /* Style for the user-selected anchor line */
        .log-line.selected-anchor {
            background-color: #2c3e50;
            /* A dark slate blue for contrast */
            border-left: 3px solid #3498db;
            /* A bright blue left border */
        }

        /* Style for collapsible file headers */
        .log-line.log-line-meta {
            cursor: pointer;
            user-select: none;
            /* Prevents text selection on click */
        }

        .log-line.log-line-meta:hover {
            background-color: #2a2a2a;
        }

        /* Style for line numbers */
        .line-number {
            display: inline-block;
            width: 50px;
            /* Adjust width as needed */
            text-align: right;
            margin-right: 10px;
            color: #777;
            /* Dim color for the line number */
        }

        #clearStateBtn {
            width: 100%;
            padding: 8px;
            background-color: #c62828;
            /* A reddish color to indicate a destructive action */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Indicator for available special logs like BTSnoop */
        .tab-btn .indicator {
            color: #34a853;
            /* Google Green */
            font-size: 1.2em;
            line-height: 1;
        }
    </style>
</head>

<body>
    <!-- OPTIMIZATION Phase 2: Skeleton Loader for Progressive Loading -->
    <div id="skeletonLoader" class="skeleton-loader" style="display: none;">
        <div class="skeleton-header">
            <div class="skeleton-logo"></div>
            <div class="skeleton-title">Loading Android Log Viewer...</div>
        </div>
        <div class="skeleton-tabs">
            <div class="skeleton-tab"></div>
            <div class="skeleton-tab"></div>
            <div class="skeleton-tab"></div>
            <div class="skeleton-tab"></div>
            <div class="skeleton-tab"></div>
        </div>
        <div class="skeleton-content">
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Android Log Viewer</h1>
            <div id="current-file-display" class="current-file-display"></div>
        </header>
        <main>
            <div class="left-panel">
                <button id="panel-toggle-btn" class="panel-toggle-btn" title="Toggle Filters Panel">&laquo;</button>
                <details id="file-selection-details" open>
                    <summary>File Selection</summary>
                    <div class="upload-column" id="upload-column">
                        <div class="upload-choice">
                            <input type="radio" id="fileChoice" name="uploadType" value="files" checked>
                            <label for="fileChoice">ZIP or Log Files</label>
                            <input type="radio" id="folderChoice" name="uploadType" value="folder">
                            <label for="folderChoice">Folder</label>
                        </div>
                        <div id="folderInputContainer" class="upload-section" style="display: none;">
                            <label for="zipInput" class="upload-label">Choose a folder containing logs:</label>
                            <input type="file" id="zipInput" name="zipInput" webkitdirectory directory />
                        </div>
                        <div id="fileInputContainer" class="upload-section">
                            <label for="logFilesInput" class="upload-label">Choose ZIP or individual log files:</label>
                            <input type="file" id="logFilesInput" name="logFilesInput" accept=".zip,.txt,.log"
                                multiple />
                        </div>
                    </div>
                    <div class="reset-section">
                        <button id="clearStateBtn" title="Clear all loaded data and reset filters">Clear &
                            Reset</button>
                    </div>
                </details>
                <div class="filter-column">
                    <section class="filter-section" id="filterSection">
                        <div class="log-level-filters">
                            <span>Filter by Level:</span>
                            <button class="filter-icon active" data-level="V">Verbose</button>
                            <button class="filter-icon active" data-level="D">Debug</button>
                            <button class="filter-icon active" data-level="I">Info</button>
                            <button class="filter-icon active" data-level="W">Warn</button>
                            <button class="filter-icon active" data-level="E">Error</button>
                            <button id="logLevelToggleBtn" class="filter-action-btn">None</button>
                        </div>
                    </section>
                    <section class="search-section">
                        <label for="searchInput">Keyword Search:</label>
                        <div class="logic-toggle">
                            <button id="logicOrBtn" class="logic-btn active"
                                title="Show lines that match ANY active keyword">OR</button>
                            <button id="logicAndBtn" class="logic-btn"
                                title="Show lines that match ALL active keywords">AND</button>
                        </div>
                        <div class="search-input-wrapper" style="position: relative;">
                            <input type="text" id="searchInput" name="searchInput" class="search-input"
                                placeholder="Live search or type & Enter... (#123 to jump to line)"
                                autocomplete="off" />
                            <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
                        </div>
                        <div id="keywordChips" class="keyword-chips"></div>
                    </section>
                    <section class="time-range-section">
                        <label for="startTime">Time Range:</label>
                        <div class="time-filter-controls">
                            <input type="datetime-local" id="startTime" name="startTime" />
                            <input type="datetime-local" id="endTime" name="endTime" />
                        </div>
                        <!-- Slider container, now outside the controls flexbox -->
                        <div id="timeRangeSliderContainer"
                            style="width: 100%; padding: 20px 5px 10px 5px; box-sizing: border-box; display: none;">
                            <div id="timeRangeSlider"></div>
                        </div>
                    </section>
                </div>
                <div id="resize-handle" class="resize-handle"></div>
            </div>
            <div class="main-content">
                <nav class="tab-nav">
                    <button class="tab-btn active" data-tab="logs">Logs</button>
                    <button class="tab-btn" data-tab="connectivity">CCC_Focus</button>
                    <button class="tab-btn" data-tab="ccc">CCC BLE Decoded packets</button>
                    <button class="tab-btn" data-tab="btsnoop">BTSnoop <span id="btsnoopIndicator" class="indicator"
                            style="display: none;">‚óè</span></button>
                    <button class="tab-btn" data-tab="stats">Stats</button>
                </nav>
                <section id="logsTab" class="tab-content active">
                    <div class="tab-header-row" style="justify-content: flex-end;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button id="collapseAllBtn" class="control-btn" title="Collapse All Files">‚äü</button>
                            <button id="sortBySizeBtn" class="control-btn"
                                title="Sort by Size (Largest First)">üìä</button>
                            <button id="exportLogsBtn" class="header-export-btn"
                                title="Export Filtered Logs">üì•</button>
                        </div>
                    </div>
                    <div id="logContainer" class="log-container">
                        <div id="logSizer" class="log-sizer"></div>
                        <div id="logViewport" class="log-viewport"></div>
                    </div>
                </section>

                <!-- NEW: Unified Connectivity Tab (BLE, NFC, DCK) -->
                <section id="connectivityTab" class="tab-content">
                    <div class="connectivity-header">
                        <!-- DCK Controls (Default Checked) -->
                        <div class="tech-section">
                            <div class="tech-master-toggle">
                                <label class="switch-label">
                                    <input type="checkbox" id="masterToggleDck" name="masterToggleDck" checked>
                                    <span class="tech-name">DCK</span>
                                </label>
                            </div>
                        </div>

                        <!-- Wallet Controls (Default Checked) -->
                        <div class="tech-section">
                            <div class="tech-master-toggle">
                                <label class="switch-label">
                                    <input type="checkbox" id="masterToggleWallet" name="masterToggleWallet" checked>
                                    <span class="tech-name">Wallet</span>
                                </label>
                            </div>
                        </div>

                        <!-- UWB Controls (Default Checked) -->
                        <div class="tech-section">
                            <div class="tech-master-toggle">
                                <label class="switch-label">
                                    <input type="checkbox" id="masterToggleUwb" name="masterToggleUwb" checked>
                                    <span class="tech-name">UWB / Nearby</span>
                                </label>
                            </div>
                        </div>

                        <!-- Bluetooth Controls -->
                        <div class="tech-section">
                            <div class="tech-master-toggle">
                                <label class="switch-label">
                                    <input type="checkbox" id="masterToggleBle" name="masterToggleBle" checked>
                                    <span class="tech-name">Bluetooth</span>
                                </label>
                            </div>
                            <div class="log-level-filters ble-filters" id="bleFiltersPanel">
                                <button class="filter-icon active" data-ble-filter="manager">Manager</button>
                                <button class="filter-icon active" data-ble-filter="gatt">GATT</button>
                                <button class="filter-icon active" data-ble-filter="smp">SMP</button>
                                <button class="filter-icon active" data-ble-filter="hci">HCI</button>
                            </div>
                        </div>

                        <!-- NFC Controls -->
                        <div class="tech-section">
                            <div class="tech-master-toggle">
                                <label class="switch-label">
                                    <input type="checkbox" id="masterToggleNfc" name="masterToggleNfc" checked>
                                    <span class="tech-name">NFC</span>
                                </label>
                            </div>
                            <div class="log-level-filters nfc-filters" id="nfcFiltersPanel">
                                <button class="filter-icon active" data-nfc-filter="framework">Framework</button>
                                <button class="filter-icon active" data-nfc-filter="hce">Card Emulation</button>
                                <button class="filter-icon active" data-nfc-filter="p2p">P2P</button>
                                <button class="filter-icon active" data-nfc-filter="hal">HAL/Native</button>
                            </div>
                        </div>
                    </div>

                    <div id="connectivityLogContainer" class="log-container">
                        <div id="connectivityLogSizer" class="log-sizer"></div>
                        <div id="connectivityLogViewport" class="log-viewport"></div>
                    </div>

                    <div class="connectivity-actions">
                        <button id="exportConnectivityBtn" class="header-export-btn" title="Export to Excel">üì•</button>
                    </div>
                </section>

                <!-- NEW: Dedicated CCC Analysis Tab -->
                <section id="cccTab" class="tab-content" style="overflow-y: auto; padding: 1rem;">
                    <div class="dashboard-card full-width-card" id="cccStatsCard" style="margin-bottom: 1.5rem;">
                        <div class="card-header"
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Digital Car Key (CCC) Analysis</h3>
                            <button id="exportCccBtn" class="header-export-btn" title="Export to Excel">üì•</button>
                        </div>
                        <div id="cccStatsContainer"></div>
                    </div>
                </section>

                <section id="btsnoopTab" class="tab-content">
                    <div class="tab-header-row">
                        <div class="log-level-filters btsnoop-filters" style="margin-bottom: 0;">
                            <div class="filter-group" id="btsnoopFilterContainer">
                                <button class="filter-icon active" data-btsnoop-filter="cmd">CMD</button>
                                <button class="filter-icon active" data-btsnoop-filter="evt">EVT</button>
                                <button class="filter-icon active" data-btsnoop-filter="acl">ACL</button>
                                <button class="filter-icon active" data-btsnoop-filter="l2cap">L2CAP</button>
                                <button class="filter-icon active" data-btsnoop-filter="smp">SMP</button>
                                <button class="filter-icon active" data-btsnoop-filter="att">ATT</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button id="btsnoopToggleCollapseBtn" class="control-btn"
                                title="Collapse All Files">‚äü</button>
                            <button id="exportBtsnoopXlsxBtn" class="header-export-btn"
                                title="Export to Excel">üì•</button>
                        </div>
                    </div>

                    <div id="btsnoopInitialView" style="text-align: center; padding: 4rem 0;">
                        <!-- This content will be managed by JS -->
                    </div>
                    <div id="btsnoopContentView" style="display: none; height: 100%; flex-direction: column;">
                        <div id="btsnoopHeader"></div>
                        <div id="btsnoopLogContainer" class="log-container">
                            <div id="btsnoopLogSizer"></div>
                            <div id="btsnoopLogViewport"></div>
                        </div>
                    </div>
                </section>

                <section id="statsTab" class="tab-content" style="overflow-y: auto; padding: 1rem;">
                    <div class="tab-header-row" style="margin-bottom: 1rem;">
                        <h2 style="margin: 0; font-size: 1.5rem; color: #e8eaed;">System Statistics</h2>
                        <button id="exportStatsBtn" class="header-export-btn" title="Export to Excel">üì•</button>
                    </div>

                    <!-- Section 2: BLE & System Highlights -->
                    <div class="dashboard-card full-width-card" id="highlightsCard" style="margin-bottom: 1.5rem;">
                        <h3>BLE & System Highlights</h3>
                        <div class="highlight-section">
                            <h4>Accounts Found</h4>
                            <ul id="accountsList" class="highlight-list"></ul>
                        </div>
                        <div class="highlight-section">
                            <h4>BLE Security Keys</h4>
                            <div style="overflow-x: auto;">
                                <table id="bleKeysTable" class="ccc-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 80px;">Packet #</th>
                                            <th style="width: 150px;">Timestamp</th>
                                            <th style="width: 200px;">Peer Address</th>
                                            <th style="width: 150px;">Key Type</th>
                                            <th>Key Value</th>
                                            <th>Raw Data</th>
                                        </tr>
                                        <tr class="filter-row">
                                            <th style="width: 80px;"><input type="text" placeholder="Filter..."
                                                    data-col="0" name="bleKeysFilter0"></th>
                                            <th style="width: 150px;"><input type="text" placeholder="Filter..."
                                                    data-col="1" name="bleKeysFilter1"></th>
                                            <th style="width: 200px;"><input type="text" placeholder="Filter..."
                                                    data-col="2" name="bleKeysFilter2"></th>
                                            <th style="width: 150px;"><input type="text" placeholder="Filter..."
                                                    data-col="3" name="bleKeysFilter3"></th>
                                            <th><input type="text" placeholder="Filter..." data-col="4"
                                                    name="bleKeysFilter4"></th>
                                            <th><input type="text" placeholder="Filter..." data-col="5"
                                                    name="bleKeysFilter5"></th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="highlight-section">
                            <h4>BTSnoop Connection Events</h4>
                            <div style="overflow-x: auto;">
                                <table id="btsnoopConnectionEventsTable" class="ccc-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">Packet No.</th>
                                            <th style="width: 140px;">Timestamp</th>
                                            <th style="width: 120px;">Event Type</th>
                                            <th style="width: 140px;">Connection Handle</th>
                                            <th style="width: 150px;">Peer Address</th>
                                            <th style="width: 300px;">Parameters</th>
                                            <th>Raw Data</th>
                                        </tr>
                                        <tr class="filter-row">
                                            <th style="width: 100px;"><input type="text" placeholder="Filter..."
                                                    data-col="0" name="btsnoopConnFilter0"></th>
                                            <th style="width: 140px;"><input type="text" placeholder="Filter..."
                                                    data-col="1" name="btsnoopConnFilter1"></th>
                                            <th style="width: 120px;"><input type="text" placeholder="Filter..."
                                                    data-col="2" name="btsnoopConnFilter2"></th>
                                            <th style="width: 140px;"><input type="text" placeholder="Filter..."
                                                    data-col="3" name="btsnoopConnFilter3"></th>
                                            <th style="width: 150px;"><input type="text" placeholder="Filter..."
                                                    data-col="4" name="btsnoopConnFilter4"></th>
                                            <th style="width: 200px;"><input type="text" placeholder="Filter..."
                                                    data-col="5" name="btsnoopConnFilter5"></th>
                                            <th><input type="text" placeholder="Filter..." data-col="6"
                                                    name="btsnoopConnFilter6"></th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2.5: Device & Setting Events (Separate Section) -->
                    <div class="dashboard-card full-width-card" id="deviceEventsCard" style="margin-bottom: 1.5rem;">
                        <h3>Device & Setting Events</h3>
                        <div style="overflow-x: auto;">
                            <table id="deviceEventsTable" class="ccc-table">
                                <thead>
                                    <tr>
                                        <th style="width: 90px;">Date</th>
                                        <th style="width: 90px;">Time</th>
                                        <th style="width: 200px;">Event</th>
                                        <th style="width: 150px;">Current Value</th>
                                        <th style="width: 150px;">Previous Value</th>
                                        <th style="min-width: 400px;">Original Log Line</th>
                                    </tr>
                                    <tr class="filter-row">
                                        <th style="width: 90px;"><input type="text" placeholder="Filter..." data-col="0"
                                                name="deviceEventsFilter0"></th>
                                        <th style="width: 90px;"><input type="text" placeholder="Filter..." data-col="1"
                                                name="deviceEventsFilter1"></th>
                                        <th style="width: 200px;"><input type="text" placeholder="Filter..."
                                                data-col="2" name="deviceEventsFilter2"></th>
                                        <th style="width: 150px;"><input type="text" placeholder="Filter..."
                                                data-col="3" name="deviceEventsFilter3"></th>
                                        <th style="width: 150px;"><input type="text" placeholder="Filter..."
                                                data-col="4" name="deviceEventsFilter4"></th>
                                        <th style="min-width: 400px;"><input type="text" placeholder="Filter..."
                                                data-col="5" name="deviceEventsFilter5"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Section 3: Other Statistics -->
                    <div class="dashboard-grid">
                        <div class="dashboard-card" id="logSummaryCard">
                            <h3>Log Summary</h3>
                            <div id="logCounts"></div>
                            <div id="errorDistribution"></div>
                        </div>
                        <div class="dashboard-card" id="cpuLoadCard">
                            <h3>CPU Load</h3>
                            <div id="cpuLoadPlotContainer" class="plot-container"></div>
                            <div id="cpuLoadStats"></div>
                        </div>
                        <div class="dashboard-card" id="temperatureCard">
                            <h3>Device Temperature</h3>
                            <div id="temperaturePlotContainer" class="plot-container"></div>
                            <div id="temperatureStats"></div>
                        </div>
                        <div class="dashboard-card" id="batteryCard">
                            <h3>Battery Level</h3>
                            <div id="batteryPlotContainer" class="plot-container"></div>
                            <div id="batteryStats"></div>
                        </div>
                        <div class="dashboard-card large-card" id="appVersionsCard">
                            <div class="card-header"
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3 style="margin: 0;">App Package Versions</h3>
                                <div class="search-section" style="padding: 0;">
                                    <label for="appSearchInput" style="display: none;">Search:</label>
                                    <input type="text" id="appSearchInput" name="appSearchInput" class="search-input"
                                        placeholder="Search packages..." autocomplete="off">
                                </div>
                            </div>
                            <div class="scrollable-table-container">
                                <table id="appVersionsTable" class="highlight-table">
                                    <thead>
                                        <tr>
                                            <th>Package</th>
                                            <th>Version</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal for selecting files from a ZIP -->
    <div id="zipModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Files Found in ZIP</h2>
            <p>Please select the log files you want to load.</p>
            <div class="toggle-all-container">
                <input type="checkbox" id="toggleAllFiles" checked />
                <label for="toggleAllFiles">Select / Deselect All</label>
            </div>
            <div id="zipFileSelection" class="file-selection-list">
                <!-- Checkboxes will be dynamically inserted here -->
            </div>
            <div class="modal-actions">
                <button id="loadSelectedBtn" class="modal-btn">Load Selected Files</button>
                <button id="cancelZipSelectionBtn" class="modal-btn cancel">Cancel</button>
            </div>
        </div>
    </div>

    <div class="progress-bar-container fixed-bottom-right">
        <div id="progressBar" class="progress-bar"></div>
        <span id="progressText" class="progress-text"></span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- noUiSlider for the time range slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css"
        integrity="sha512-qveKnGrvOChbSzAdtSs8p69eoLegyh+1hwOMbmpCViIwj7rn4oJjdmMvWOuyQlTOZgTlZA0N2PXA7iA8/2TUYA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"
        integrity="sha512-UOJe4paV6hYWBnS0c9GnIRH8PLm2nFK22uhfAvsTIqd3uwnWsVri1OPn5fJYdLtGY3wB11LGHJ4yPU1WFJeBYQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="module" src="./main.js"></script>
</body>

</html>